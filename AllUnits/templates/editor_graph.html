<!DOCTYPE html>
<html>
<head>
    <title>Система управления навыками голосового помощника</title>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="static/css/style-main.css">
    <link rel="stylesheet" href="static/css/style-tabs.css">

    <link rel="stylesheet" href="static/css/style-graph.css">
</head>

<body>
    <!-- Меню -->
    {% include "__block_tabs.html" %}

    <!-- Основная панель управления -->
    <article>
        <section class="no_text_select">
            <div>
                <h1>Справочник</h1>
                <div id="update-directory" onclick="event_update_directory();"></div>
            </div>
            <div class="button">
                <label for="upload-document">Загрузить документ</label>
                <input type="file" id="upload-document" name="upload-document" onchange="event_upload_document();" style="display: none;">
            </div>
        </section>
        <section class="no_text_select">
            <ul class="file-list" id="document-list"></ul>
            <div class="button" onclick="event_visible_graph();">Обновить граф</div>
        </section>
    </article>

    <!-- Основная панель содержимого -->
    <aside>
        <section id="graph-visible" class="no_text_select">
            <iframe style="width: 100%; height: 100%; border: none;">
                Не поддерживаются плавающие фреймы.
            </iframe>
        </section>
        <section id="table" class="no_text_select">
            <div>
                <div class="button" onclick="event_load_data();">Загрузить данные</div>
                <div class="button" onclick="event_cancel();">Отмена</div>
            </div>
            <table> </table>
        </section>
    </aside>

    <script>
        function event_update_directory() {
            var json_1 = [];
            var json_2 = [];

            fetch('/graph/update_document')
            .then(response => response.json())
            .then(data => {
                json_1 = data;

                fetch('/graph/update_reference')
                .then(response => response.json())
                .then(data => {
                    json_2 = data;

                    handleData();
                })
                .catch(error => console.error('Ошибка:', error));
            })
            .catch(error => console.error('Ошибка:', error));

            function handleData() {
                file_list = document.getElementById('document-list');
                file_list.innerHTML = '';

                let json_merged = [];
                if (json_1.length > 0 && json_2.length > 0) {
                    json_merged = json_1.concat(json_2);
                    json_merged = [...new Set(json_merged)];
                } else {
                     if (json_1.length > 0) {
                        json_merged = json_1;
                     } else if (json_2.length > 0) {
                        json_merged = json_2;
                     } else {
                        var item_list = document.createElement('li');
                        item_list.textContent = 'Нет документов.';
                        item_list.classList.add('file-item');
                        file_list.appendChild(item_list);
                        return;
                     }
                }
                json_merged.sort();

                json_merged.forEach(function(item) {
                    var item_list = document.createElement('li');
                    item_list.classList.add('file-item');

                    var item_p = document.createElement('p');
                    var item_div_1 = document.createElement('div');
                    var item_div_2 = document.createElement('div');

                    item_p.textContent = item;

                    if (json_1.includes(item)) {
                        item_div_1.classList.add("elem-load");

                        item_div_1.addEventListener('click', function() {
                            event_process_data(item);
                            swap_display("table");
                        });
                    }
                    if (json_2.includes(item)) {
                        item_div_2.classList.add("elem-delete");

                        item_div_2.addEventListener('click', function() {
                            event_delete_data(item);
                        });
                    }

                    item_list.appendChild(item_p);
                    item_list.appendChild(item_div_1);
                    item_list.appendChild(item_div_2);
                    file_list.appendChild(item_list);
                });
            }
        }

        function event_upload_document() {
            if (document.getElementById('upload-document').files[0]) {
                var form = new FormData();
                form.append('document', document.getElementById('upload-document').files[0]);

                fetch('/graph/upload_document', {
                    method: 'POST',
                    body:   form
                })
                .then(response => response.text())
                .then(data => {
                    event_update_directory();
                    console.log('Загрузка файла: ' + data);
                })
                .catch(error => console.error('Ошибка:', error));
            } else {
                console.error('Ошибка: Файл не выбран.');
            }
        }

        function event_visible_graph() {
            fetch('/graph/visible_data')
            .then(response => {
                var iframe = document.querySelector("#graph-visible iframe");
                iframe.src = "/static/graph.html";
            })
            .catch(error => console.error('Ошибка:', error));
        }
    </script>

    <!-- Событие (Event) :: Обработка данных -->
    <script>
        function event_process_data(filename) {
            fetch('/graph/process_data', {
                method:  'POST',
                headers: {'Content-Type': 'text/plain'},
                body:    filename
            })
            .then(response => response.json())
            .then(data => {
                document.querySelector("#table table").innerHTML = "";
                create_table(document.querySelector("#table table"), data);

            })
            .catch(error => console.error('Ошибка:', error));
        }

        function event_load_data() {
            fetch('/graph/load_data', {
                method:  'POST',
                headers: {'Content-Type': 'application/json'},
                body:    JSON.stringify({ table: get_table_data() })
            })
            .then(response => {
                event_update_directory();
                event_cancel();
            })
            .catch(error => console.error('Ошибка:', error));
        }

        function event_delete_data(filename) {
            fetch('/graph/delete_data', {
                method:  'POST',
                headers: {'Content-Type': 'text/plain'},
                body:    filename
            })
            .then(response => {
                event_update_directory();
            })
            .catch(error => console.error('Ошибка:', error));
        }

        function event_cancel() {
            swap_display('graph-visible');
            clear_table();
        }
    </script>

    <script>
        function get_table_data() {
            var table = document.querySelector("#table table");
            var data = [];
            var rows = table.querySelectorAll('tbody tr');
            rows.forEach(function(row) {
                var row_data = {};
                var cells = row.querySelectorAll('td');
                cells.forEach(function(cell) {
                    var value = cell.textContent;
                    if (cell.hasAttribute('data-bool')) {
                        value = cell.getAttribute('data-bool') === 'true';
                    }
                    row_data[cell.cellIndex] = value;
                });
                data.push(row_data);
            });
            return data;
        }

        function create_table(table, json_data) {
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const thead_row = document.createElement('tr');
            const tbody_obj = {};
            Object.keys(json_data).forEach(function(key) {
                const th = document.createElement('th');
                th.textContent = key;
                thead_row.appendChild(th);
                Object.keys(json_data[key]).forEach(sub_key => {
                    if (!tbody_obj[sub_key]) {
                        tbody_obj[sub_key] = [];
                    }
                    tbody_obj[sub_key].push(json_data[key][sub_key]);
                });
            });
            thead.appendChild(thead_row);
            Object.values(tbody_obj).forEach(function(row) {
                const tbody_row = document.createElement('tr');
                Object.values(row).forEach(function(value) {
                    const td = document.createElement('td');
                    td.textContent = value;
                    if (value === true || value === false) {
                        td.addEventListener('click', function() {
                            toggle_boolean_value(td);
                        });
                    }
                    tbody_row.appendChild(td);
                });
                tbody.appendChild(tbody_row);
            });
            table.appendChild(thead);
            table.appendChild(tbody);
        }

        function clear_table() {
            document.querySelector("#table table").innerHTML = "";
        }

        function toggle_boolean_value(cell) {
            cell.textContent = cell.textContent === 'true' ? 'false' : 'true';
        }

        function swap_display(display) {
            if (display === "graph-visible") {
                document.getElementById("graph-visible").style.display = "block";
                document.getElementById("table").style.display =         "none";
            } else {
                document.getElementById("graph-visible").style.display = "none";
                document.getElementById("table").style.display =         "block";
            }
        }
    </script>

    <script>
        event_update_directory();
        event_visible_graph();
        swap_display('graph-visible');
    </script>

</body>
</html>



